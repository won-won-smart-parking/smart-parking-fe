name: pull_request-ci
on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.husky/**'

# Github Actions ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: read # íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ -> ì½ê¸°ë§Œ ê°€ëŠ¥
  pull-requests: write # PR ì ‘ê·¼ ê¶Œí•œ -> ë¦¬ë·° ìž‘ì„± ê°€ëŠ¥
  checks: write # ì½”ë“œ íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ -> ìž‘ì„± ê°€ëŠ¥ (ì½”ë“œ íŒŒì¼ ì˜†ì— ë¼ì¸ìœ¼ë¡œ ëŒ“ê¸€ì„ ë‚¨ê¹€)

# ë™ì¼í•œ PRì— ì»¤ë°‹ì„ ì—°ë‹¬ì•„ ì˜¬ë¦´ ë•Œ, ê¸°ì¡´ì— ëŒë˜ ì›Œí¬í”Œë¡œìš°ë¥¼ ìžë™ ì·¨ì†Œí•´ì¤Œ
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

# Pull Request ì‹œ ê²€ì¦í•´ì•¼ í•˜ëŠ” ìž‘ì—… ëª©ë¡
jobs:
  pr-quality:
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v4

      # 2. Node.js ì„¤ì • (22.18.0 + yarn ìºì‹œ) ë‹¨ê³„
      - uses: actions/setup-node@v4
        with:
          node-version: "22.18.0" # í”„ë¡œì íŠ¸ Node ë²„ì „ ë§žì¶¤
          cache: "yarn"

      # 3. yarn ë²„ì „ ê³ ì • ë° í™•ì¸ (1.22.22) ë‹¨ê³„
      - run: corepack enable
      - run: corepack prepare yarn@1.22.22 --activate
      - run: yarn --version

      # 4. Yarn ì˜ì¡´ì„± ì„¤ì¹˜ ë° ì•ˆì •ì„± ê²€ì¦ ë‹¨ê³„
      #  -> --frozen-lockfile: package.jsonê³¼ yarn.lock ì˜ì¡´ì„± ì„¤ì¹˜ ì •ë³´ê°€ ë¶ˆì¼ì¹˜í•  ê²½ìš° PR ì‹¤íŒ¨
      #  -> --network-timeout: ëŠë¦° ë„¤íŠ¸ì›Œí¬ ì†ë„ë¡œ ì¸í•œ ê°„í—ì  ì‹¤íŒ¨ ì™„í•˜ (10ë¶„)
      - name: Install Dependencies
        run: yarn install --frozen-lockfile --network-timeout 600000

      # 5. í™˜ê²½ ë³€ìˆ˜ ìœ íš¨ì„± ê²€ì¦ ë‹¨ê³„
      - name: Env Check
        if: ${{ github.event_name == 'pull_request' }}
        env:
          NODE_ENV: ${{ secrets.NODE_ENV }}
          ENV_REPORT_JSON: env-report.json
        run: |
          BASE="${{ github.event.pull_request.base.ref }}"
          if [ "$BASE" = "main" ] || [[ "$BASE" == release* ]]; then
            echo "Full env check for $BASE"
            yarn env:check
          else
            echo "Public-only env check for $BASE"
            ENV_CHECK_MODE=public yarn env:check
          fi

      # 6. TypeScript Compiler íƒ€ìž… ì²´í¬ ë‹¨ê³„
      - name: TypeScript Typecheck
        run: yarn typecheck 2> ts-error-report.txt

      # 7. ì—„ê²©í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê²€ì¦
      - name: Full Regression Test
        run: yarn test:ci

      # 8. ì˜ì¡´ì„± ì ê²€ ê²€ì¦ ë‹¨ê³„
      - name: Dependency Audit
        run: yarn audit:ci
      
      ### ì˜ì¡´ì„± ë¦¬í¬íŠ¸ ìƒì„± (ê²€ì¦ ë‹¨ê³„ì—ì„œ ê°™ì´ í•˜ë©´ yarn audit:ci ì‹¤íŒ¨ ì‹œ ë¦¬í¬íŠ¸ ìƒì„± ì•ˆë¨)
      - name: Generate dependency audit report
        run: npm audit --json > dependency-audit-report.json || true

      # 9. ESLint ê·œì¹™ ê²€ì¦(ê²½ê³ ë„ ì‹¤íŒ¨ ì²˜ë¦¬)
      - name: ESLint
        run: yarn lint:strict -f json -o eslint-report.json

      # 10. Prettier í¬ë§·íŒ… ê²€ì¦ ë‹¨ê³„
      - name: Prettier Formatting
        run: yarn prettier
      
      # 11. ë¦¬í¬íŠ¸ & ì»¤ë²„ë¦¬ì§€ ë³´ê³ ì„œ ì—…ë¡œë“œ (PR ì‹¤íŒ¨ ì‹œì—ë„ í•­ìƒ ì—…ë¡œë“œ)
      - name: Upload ESLint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: eslint-report.json
          if-no-files-found: ignore
          retention-days: 3
      - name: Upload TypeScript errors
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ts-error-report
          path: ts-error-report.txt
          if-no-files-found: ignore
          retention-days: 3
      - name: Upload env check report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: env-report
          path: env-report.json
          if-no-files-found: ignore
          retention-days: 3
      - name: Upload dependency audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-report
          path: dependency-audit-report.json
          if-no-files-found: ignore
          retention-days: 3
      - name: Upload Jest coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: |
            coverage/lcov.info
            coverage/**/*.*
          if-no-files-found: ignore
          retention-days: 3
  
  # Code Review ì½”ë©˜íŠ¸ ìžë™í™” ìž‘ì—…
  code-review:
    needs: pr-quality
    if: always()
    runs-on: ubuntu-latest
    steps:
      # 1) ë¦¬í¬íŠ¸ ë‚´ë ¤ë°›ê¸° (ì—†ì–´ë„ ê³„ì† ì§„í–‰)
      - name: Download ESLint report
        uses: actions/download-artifact@v4
        with:
          name: eslint-report
          path: reports
        continue-on-error: true

      - name: Download TypeScript errors
        uses: actions/download-artifact@v4
        with:
          name: ts-error-report
          path: reports
        continue-on-error: true

      - name: Download Env check report
        uses: actions/download-artifact@v4
        with:
          name: env-report
          path: reports
        continue-on-error: true

      - name: Download dependency audit report
        uses: actions/download-artifact@v4
        with:
          name: dependency-audit-report
          path: reports
        continue-on-error: true

      - name: Download Jest coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-lcov
          path: reports
        continue-on-error: true

      # 2) ì»¤ë²„ë¦¬ì§€ íŒŒì¼ ì¡´ìž¬ ì—¬ë¶€ ì²´í¬
      - name: Check coverage file
        id: cov
        shell: bash
        run: |
          if [ -f "reports/coverage/lcov.info" ]; then
            echo "has=true" >> $GITHUB_OUTPUT
          else
            echo "has=false" >> $GITHUB_OUTPUT
          fi

      # 3) ìžˆìœ¼ë©´ ìš”ì•½ ìƒì„±, ì—†ìœ¼ë©´ ìŠ¤í‚µ
      - name: Generate coverage summary (Markdown)
        if: steps.cov.outputs.has == 'true'
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          format: markdown
          output: both
          filename: reports/coverage/lcov.info
          thresholds: '60 50'

      # 4) ì—†ì„ ë•Œ ëŒ€ì²´ ë©”ì‹œì§€ íŒŒì¼ ë§Œë“¤ì–´ë‘ê¸°
      - name: Create empty coverage summary
        if: steps.cov.outputs.has != 'true'
        run: echo "_í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ê°€ ì—†ìŒ_" > code-coverage-results.md

      # 5) PR ì½”ë©˜íŠ¸(í•­ìƒ ì‹¤í–‰)
      - name: Build review comment
        if: always()
        shell: bash
        run: |
          echo "## ðŸ§ª í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ìš”ì•½ ë‚´ìš©" > pr-comment.md
          if [ -f code-coverage-results.md ]; then
            cat code-coverage-results.md >> pr-comment.md
          else
            echo "_í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ê°€ ì—†ìŒ_" >> pr-comment.md
          fi

          echo -e "\n## ðŸ” ì ê²€ ì‚¬í•­" >> pr-comment.md
          [ -f reports/eslint-report.json ] && echo "- ESLint: \`eslint-report.json\` ì²¨ë¶€ë¨" >> pr-comment.md || echo "- ESLint: (ì—†ìŒ)" >> pr-comment.md
          [ -f reports/ts-error-report.txt ] && echo "- TypeScript: \`ts-error-report.txt\` ì²¨ë¶€ë¨" >> pr-comment.md || echo "- TypeScript: (ì—†ìŒ)" >> pr-comment.md
          [ -f reports/env-report.json ] && echo "- Env Check: \`env-report.json\` ì²¨ë¶€ë¨" >> pr-comment.md || echo "- Env Check: (ì—†ìŒ)" >> pr-comment.md
          [ -f reports/dependency-audit-report.json ] && echo "- Dependency Audit: \`dependency-audit-report.json\` ì²¨ë¶€ë¨" >> pr-comment.md || echo "- Dependency Audit: (ì—†ìŒ)" >> pr-comment.md

          echo -e "\n> ìƒì„¸ ë¦¬í¬íŠ¸ëŠ” 'Artifacts'ì—ì„œ ë‹¤ìš´ë¡œë“œí•´ í™•ì¸í•˜ì„¸ìš”." >> pr-comment.md

      - name: Post sticky PR comment
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "PR Quality Report"
          path: pr-comment.md