name: pull_request-ci

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.husky/**'

# Github Actions ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: read        # íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ -> ì½ê¸°ë§Œ ê°€ëŠ¥
  pull-requests: write  # PR ì ‘ê·¼ ê¶Œí•œ -> ë¦¬ë·° ì‘ì„± ê°€ëŠ¥
  checks: write         # ì½”ë“œ íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ -> ì‘ì„± ê°€ëŠ¥ (ì½”ë“œ íŒŒì¼ ì˜†ì— ë¼ì¸ìœ¼ë¡œ ëŒ“ê¸€ì„ ë‚¨ê¹€)

# ë™ì¼í•œ PRì— ì»¤ë°‹ì„ ì—°ë‹¬ì•„ ì˜¬ë¦´ ë•Œ, ê¸°ì¡´ì— ëŒë˜ ì›Œí¬í”Œë¡œìš°ë¥¼ ìë™ ì·¨ì†Œí•´ì¤Œ
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

# Pull Request ì‹œ ê²€ì¦í•´ì•¼ í•˜ëŠ” ì‘ì—… ëª©ë¡
jobs:
  pr-quality:
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Node.js ì„¤ì • (22.18.0 + yarn ìºì‹œ) ë‹¨ê³„
      - uses: actions/setup-node@v4
        with:
          node-version: "22.18.0" # í”„ë¡œì íŠ¸ Node ë²„ì „ ë§ì¶¤
          cache: "yarn"

      # 3. yarn ë²„ì „ ê³ ì • ë° í™•ì¸ (1.22.22) ë‹¨ê³„
      - run: corepack enable
      - run: corepack prepare yarn@1.22.22 --activate
      - run: yarn --version

      # 4. Yarn ì˜ì¡´ì„± ì„¤ì¹˜ ë° ì•ˆì •ì„± ê²€ì¦ ë‹¨ê³„
      #  -> --frozen-lockfile: package.jsonê³¼ yarn.lock ì˜ì¡´ì„± ì„¤ì¹˜ ì •ë³´ê°€ ë¶ˆì¼ì¹˜í•  ê²½ìš° PR ì‹¤íŒ¨
      #  -> --network-timeout: ëŠë¦° ë„¤íŠ¸ì›Œí¬ ì†ë„ë¡œ ì¸í•œ ê°„í—ì  ì‹¤íŒ¨ ì™„í•˜ (10ë¶„)
      - name: Install Dependencies
        run: yarn install --frozen-lockfile --network-timeout 600000

      # 5. í™˜ê²½ ë³€ìˆ˜ ìœ íš¨ì„± ê²€ì¦ ë‹¨ê³„
      - name: Env Check
        if: ${{ github.event_name == 'pull_request' }}
        env:
          NODE_ENV: ${{ secrets.NODE_ENV }}
          ENV_REPORT_JSON: env-report.json
        run: |
          BASE="${{ github.event.pull_request.base.ref }}"
          if [ "$BASE" = "main" ] || [[ "$BASE" == release* ]]; then
            echo "Full env check for $BASE"
            yarn env:check:full
          else
            echo "Light env check for $BASE"
            yarn env:check:light
          fi

      # 6. TypeScript Compiler íƒ€ì… ì²´í¬ ë‹¨ê³„
      - name: TypeScript Typecheck
        run: yarn typecheck 2> ts-error-report.txt

      # 7. ì—„ê²©í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê²€ì¦
      - name: Full Regression Test
        run: yarn test:ci

      # 8. ì˜ì¡´ì„± ì ê²€ ê²€ì¦ ë‹¨ê³„
      - name: Dependency Audit
        run: yarn audit:ci
      
      ### ì˜ì¡´ì„± ë¦¬í¬íŠ¸ ìƒì„± (ê²€ì¦ ë‹¨ê³„ì—ì„œ ê°™ì´ í•˜ë©´ yarn audit:ci ì‹¤íŒ¨ ì‹œ ë¦¬í¬íŠ¸ ìƒì„± ì•ˆë¨)
      - name: Generate dependency audit report
        run: yarn audit --json | jq -s '.' > dependency-audit-report.json || true

      # 9. ESLint ê·œì¹™ ê²€ì¦(ê²½ê³ ë„ ì‹¤íŒ¨ ì²˜ë¦¬)
      - name: ESLint
        run: yarn lint:strict -f json -o eslint-report.json

      # 10. Prettier í¬ë§·íŒ… ê²€ì¦ ë‹¨ê³„
      - name: Prettier Formatting
        run: yarn format
      
      # 11. ë¦¬í¬íŠ¸ & ì»¤ë²„ë¦¬ì§€ ë³´ê³ ì„œ ì—…ë¡œë“œ (PR ì‹¤íŒ¨ ì‹œì—ë„ í•­ìƒ ì—…ë¡œë“œ)
      - name: Upload ESLint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: eslint-report.json
          if-no-files-found: ignore
          retention-days: 3

      - name: Upload TypeScript errors
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ts-error-report
          path: ts-error-report.txt
          if-no-files-found: ignore
          retention-days: 3

      - name: Upload Jest JSON summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jest-summary
          path: jest-summary.json
          if-no-files-found: ignore
          retention-days: 3

      - name: Upload env check report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: env-report
          path: env-report.json
          if-no-files-found: ignore
          retention-days: 3

      - name: Upload dependency audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-report
          path: dependency-audit-report.json
          if-no-files-found: ignore
          retention-days: 3

      - name: Upload Jest coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: |
            coverage/lcov.info
            coverage/**/*.*
          if-no-files-found: ignore
          retention-days: 3
  
  code-review:
    needs: pr-quality
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download ESLint report
        uses: actions/download-artifact@v4
        with:
          name: eslint-report
          path: reports
        continue-on-error: true

      - name: Download TypeScript errors
        uses: actions/download-artifact@v4
        with:
          name: ts-error-report
          path: reports
        continue-on-error: true

      - name: Download Env check report
        uses: actions/download-artifact@v4
        with:
          name: env-report
          path: reports
        continue-on-error: true

      - name: Download dependency audit report
        uses: actions/download-artifact@v4
        with:
          name: dependency-audit-report
          path: reports
        continue-on-error: true

      - name: Download Jest coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-lcov
          path: reports
        continue-on-error: true

      - name: Download Jest JSON summary
        uses: actions/download-artifact@v4
        with:
          name: jest-summary
          path: reports
        continue-on-error: true
      
      # íŒŒì¼ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰ (ì—†ìœ¼ë©´ ìŠ¤í‚µ)
      - name: Generate coverage summary (Markdown)
        uses: irongut/CodeCoverageSummary@v1.3.0
        if: always() && hashFiles('reports/coverage/lcov.info') != ''
        with:
          format: markdown
          output: both
          filename: reports/coverage/lcov.info
          thresholds: '60 50'

      - name: Build rich PR quality comment
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
      
      - name: Compose markdown from reports
        shell: bash
        run: |
          node <<'NODE'
          const fs = require('fs');
          const p = (f) => `reports/${f}`;
          const readJSON = (file) => { try { return JSON.parse(fs.readFileSync(file,'utf8')); } catch { return null; } };
          const readTXT  = (file) => { try { return fs.readFileSync(file,'utf8'); } catch { return ''; } };
          const exists   = (file) => fs.existsSync(file);

          // 1) Env Check
          const envReport = readJSON(p('env-report.json'));
          const envErrCnt = envReport?.errors?.length ?? 0;
          const envStatus = envReport?.ok === false ? `âŒ Fail (${envErrCnt} errors)` : 'âœ… Pass';

          // 2) TypeScript
          const tsTxt = readTXT(p('ts-error-report.txt'));
          const tsErrors = tsTxt.trim() ? (tsTxt.split('\n').filter(Boolean).length) : 0;
          const tsStatus = tsErrors === 0 ? 'âœ… Pass (0 errors)' : `âŒ Fail (${tsErrors} lines)`;

          // 3) ESLint
          const eslint = readJSON(p('eslint-report.json')) || [];
          const eslintIssues = Array.isArray(eslint) ? eslint.reduce((sum,f)=> sum + (f.messages?.length||0), 0) : 0;
          const eslintStatus = eslintIssues === 0 ? 'âœ… Pass (0 issues)' : `âŒ Fail (${eslintIssues} issues)`;

          // 4) Unit Tests
          const jestSum = readJSON(p('jest-summary.json')) || {};
          const numTotal  = Number.isFinite(jestSum.numTotalTests)  ? jestSum.numTotalTests  : 0;
          const numPassed = Number.isFinite(jestSum.numPassedTests) ? jestSum.numPassedTests : 0;
          const numFailed = Number.isFinite(jestSum.numFailedTests) ? jestSum.numFailedTests : 0;
          const testStatus = numFailed === 0
            ? `âœ… Pass (${numPassed}/${numTotal})`
            : `âŒ Fail (${numFailed} failed / ${numTotal})`;

          // 5) Dependency (npm audit)
          const audit = readJSON(p('dependency-audit-report.json')) || {};
          const vuln = audit.metadata?.vulnerabilities || audit.vulnerabilities || {};
          const totals = {
            critical: vuln.critical || 0, high: vuln.high || 0,
            moderate: vuln.moderate || 0, low: vuln.low || 0, info: vuln.info || 0
          };
          const totalV = totals.critical + totals.high + totals.moderate + totals.low + totals.info;
          const depStatus = totalV === 0
            ? 'âœ… Pass (0)'
            : `âš ï¸ ${totalV} vulns (crit:${totals.critical}, high:${totals.high}, mod:${totals.moderate})`;

          // 6) Coverage
          let coverageTable = '';
          const covJsonPath = 'reports/coverage/coverage-summary.json';
          if (exists(covJsonPath)) {
            const cov = readJSON(covJsonPath) || {};
            const g = cov.total || {};
            const pc = (x) => (x && Number.isFinite(x.pct) ? x.pct : 0);
            coverageTable =
            `| í•­ëª© | ë¹„ìœ¨ |
            |------|------|
            | Statements | ${pc(g.statements)}% |
            | Branches   | ${pc(g.branches)}%   |
            | Functions  | ${pc(g.functions)}%  |
            | Lines      | ${pc(g.lines)}%      |`;
          } else if (exists('code-coverage-results.md')) {
            coverageTable = fs.readFileSync('code-coverage-results.md','utf8');
          } else {
            coverageTable = '_í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ê°€ ì—†ìŒ_';
          }

          // 7) Markdown
          let md = '';
          md += '## ğŸ“Š PR í’ˆì§ˆ ìš”ì•½\n\n';
          md += '### ğŸ§¾ ë¶„ì„ ê²°ê³¼\n';
          md += '| í•­ëª© | ìƒíƒœ |\n|------|------|\n';
          md += `| Env Check  | ${envStatus} |\n`;
          md += `| TypeScript | ${tsStatus} |\n`;
          md += `| ESLint     | ${eslintStatus} |\n`;
          md += `| Unit Tests | ${testStatus} |\n`;
          md += `| Dependency | ${depStatus} |\n\n`;
          md += '### ğŸ“ˆ Coverage\n';
          md += coverageTable + '\n\n';
          md += '> ìƒì„¸ ë¦¬í¬íŠ¸ëŠ” GitHub Actions **Artifacts**ì—ì„œ í™•ì¸í•˜ì„¸ìš”.\n';

          fs.writeFileSync('pr-comment.md', md);
          NODE

      - name: Post sticky PR comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "PR Quality Report"
          path: pr-comment.md