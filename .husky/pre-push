#!/bin/sh

# Git Push ì•ˆì „ì„± ê²€ì¦ íŒŒì´í”„ë¼ì¸
# 1. ì‹œí¬ë¦¿ í‚¤ ê²€ì¦
if command -v gitleaks >/dev/null 2>&1; then
  echo "â–¶ push ì „ gitleaksë¡œ ì‹œí¬ë¦¿ ìŠ¤ìº”ì„ ì‹¤í–‰í•©ë‹ˆë‹¤..."
  gitleaks detect --no-git --source . --redact --no-banner
else
  echo "âš ï¸ gitleaksê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šì•„ ì‹œí¬ë¦¿ ìŠ¤ìº”ì„ ê±´ë„ˆëœë‹ˆë‹¤."
  echo "   ì„¤ì¹˜ ë°©ë²•: macOS â†’ brew install gitleaks / Windows â†’ choco install gitleaks"
fi

# 2. ë¸Œëœì¹˜ íŒ¨í„´ ê²€ì‚¬
BRANCH_NAME=$(git symbolic-ref --short HEAD)
if ! echo "$BRANCH_NAME" | grep -Eq '^(main|release|dev|hotfix|feat\/[a-z0-9._-]+|fix\/[a-z0-9._-]+|refactor\/[a-z0-9._-]+|test\/[a-z0-9._-]+|docs\/[a-z0-9._-]+|chore\/[a-z0-9._-]+)$'; then
  echo "ğŸš« ë¸Œëœì¹˜ ì´ë¦„ ì˜ëª» ì‘ì„±í•¨!!"
  echo "ì´ ì¤‘ì— í•˜ë‚˜ë§Œ í—ˆìš©: main, release, dev, hotfix, <type>/<desc>"
  exit 1
fi

# 3. í™˜ê²½ ë³€ìˆ˜ ìœ íš¨ì„± ê²€ì¦
echo "Push ì „ í™˜ê²½ ë³€ìˆ˜ ìœ íš¨ì„± ê²€ì¦..."
yarn env:check || exit 1

# 4. íƒ€ì… ì•ˆì „ì„± ê²€ì¦
echo "Push ì „ íƒ€ì… ì•ˆì „ì„± ê²€ì¦..."
yarn typecheck || exit 1

# 5. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸(Jest + RTL)
echo "...í…ŒìŠ¤íŠ¸ íŒŒì¼ ìˆ˜ì§‘ ì¤‘..."

### 1) í˜„ì¬ commit ë‹¨ê³„ì˜ ìŠ¤í…Œì´ì§• ì˜ì—­ í…ŒìŠ¤íŠ¸ íŒŒì¼ ìˆ˜ì§‘
STAGED_FILES=$(git diff --cached --name-only --diff-filter=AMR 2>/dev/null || true)
STAGED_TESTS=$(printf "%s\n" "$STAGED_FILES" | grep -E '(^|/)(__tests__/.*|.*\.(test|spec)\.[tj]sx?)$' || true)

### 2) í˜„ì¬ commit ë‹¨ê³„ì— í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ì„ ê²½ìš° ì´ì „ í…ŒìŠ¤íŠ¸ íŒŒì¼ ìˆ˜ì§‘ (ë³€ê²½ëœ í…ŒìŠ¤íŠ¸ íŒŒì¼ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê¸° ìœ„í•´ì„œ)
if git rev-parse --abbrev-ref @{upstream} >/dev/null 2>&1; then
  BASE=$(git merge-base HEAD @{upstream})
else
  BASE=$(git rev-list --max-parents=0 HEAD)
fi
RANGE_FILES=$(git diff --name-only --diff-filter=AMR "$BASE"...HEAD 2>/dev/null || true)
RANGE_TESTS=$(printf "%s\n" "$RANGE_FILES" | grep -E '(^|/)(__tests__/.*|.*\.(test|spec)\.[tj]sx?)$' || true)

ALL_TESTS=$(printf "%s\n%s\n" "$STAGED_TESTS" "$RANGE_TESTS" | sed '/^$/d' | sort -u)

if [ -n "$ALL_TESTS" ]; then
  echo "ë³€ê²½ ë˜ëŠ” ì¶”ê°€ëœ í…ŒìŠ¤íŠ¸ íŒŒì¼:"
  printf "%s\n" "$ALL_TESTS" | sed 's/^/   - /'
  echo "Push ì „ ë³€ê²½ / ì¶”ê°€ëœ í…ŒìŠ¤íŠ¸ íŒŒì¼ í…ŒìŠ¤íŠ¸ ë‹¨ê³„ ìˆ˜í–‰..."
  printf "%s\0" $ALL_TESTS | xargs -0 yarn jest --bail --maxWorkers=50% --passWithNoTests || exit 1
else
  echo "ë³€ê²½ ë˜ëŠ” ì¶”ê°€ëœ í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ì–´ í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœ€!!"
fi

# 6. ì½”ë“œ ìŠ¤íƒ€ì¼ ê·œì¹™ ê²€ì¦
echo "Push ì „ ì—„ê²©í•œ Lint ê·œì¹™ ê²€ì¦..."
yarn lint:strict || exit 1