#!/bin/sh

# Git Push ì•ˆì „ì„± ê²€ì¦ íŒŒì´í”„ë¼ì¸
# 1. ì‹œí¬ë¦¿ í‚¤ ê²€ì¦
if command -v gitleaks >/dev/null 2>&1; then
  echo "â–¶ push ì „ gitleaksë¡œ ì‹œí¬ë¦¿ ìŠ¤ìº”ì„ ì‹¤í–‰í•©ë‹ˆë‹¤..."
  gitleaks detect --no-git --source . --redact --no-banner
else
  echo "âš ï¸ gitleaksê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šì•„ ì‹œí¬ë¦¿ ìŠ¤ìº”ì„ ê±´ë„ˆëœë‹ˆë‹¤."
  echo "   ì„¤ì¹˜ ë°©ë²•: macOS â†’ brew install gitleaks / Windows â†’ choco install gitleaks"
fi

# 2. ë¸Œëœì¹˜ íŒ¨í„´ ê²€ì‚¬
BRANCH_NAME=$(git symbolic-ref --short HEAD)
if ! echo "$BRANCH_NAME" | grep -Eq '^(main|release|dev|hotfix|feat\/[a-z0-9._-]+|fix\/[a-z0-9._-]+|refactor\/[a-z0-9._-]+|test\/[a-z0-9._-]+|docs\/[a-z0-9._-]+|chore\/[a-z0-9._-]+)$'; then
  echo "ğŸš« ë¸Œëœì¹˜ ì´ë¦„ ì˜ëª» ì‘ì„±í•¨!!"
  echo "ì´ ì¤‘ì— í•˜ë‚˜ë§Œ í—ˆìš©: main, release, dev, hotfix, <type>/<desc>"
  exit 1
fi

# 3. í™˜ê²½ ë³€ìˆ˜ ìœ íš¨ì„± ê²€ì¦
echo "Push ì „ í™˜ê²½ ë³€ìˆ˜ ìœ íš¨ì„± ê²€ì¦..."
yarn env:check || exit 1

# 4. íƒ€ì… ì•ˆì „ì„± ê²€ì¦
echo "Push ì „ íƒ€ì… ì•ˆì „ì„± ê²€ì¦..."
yarn typecheck || exit 1

# 5. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸(Jest + RTL)
echo "Push ì „ êµ¬í˜„í•œ ê¸°ëŠ¥ê´€ ê´€ë ¨ëœ í…ŒìŠ¤íŠ¸ ì½”ë“œ ìˆ˜í–‰(ì—†ìœ¼ë©´ ìë™ í†µê³¼)..."
yarn test:related

# 6. ì½”ë“œ ìŠ¤íƒ€ì¼ ê·œì¹™ ê²€ì¦
echo "Push ì „ ì—„ê²©í•œ Lint ê·œì¹™ ê²€ì¦..."
yarn lint:strict || exit 1