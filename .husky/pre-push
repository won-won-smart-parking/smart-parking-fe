#!/bin/sh

# Git Push ì•ˆì „ì„± ê²€ì¦ íŒŒì´í”„ë¼ì¸
# 1. ë¸Œëžœì¹˜ íŒ¨í„´ ê²€ì‚¬
BRANCH_NAME=$(git symbolic-ref --short HEAD)
echo "$BRANCH_NAME" | grep -Eq '^(main|release|dev|hotfix|docs|feat/[a-z0-9._/-]+|fix/[a-z0-9._/-]+|refactor/[a-z0-9._/-]+|test/[a-z0-9._/-]+|chore/[a-z0-9._/-]+)$' \
  || { echo "ðŸš« ë¸Œëžœì¹˜ ì´ë¦„ ìž˜ëª» ìž‘ì„±í•¨!!"; exit 1; }

# 2. ì‹œí¬ë¦¿ í‚¤ ê²€ì¦
if ! command -v gitleaks >/dev/null 2>&1; then
  echo "âš ï¸ gitleaksê°€ ì„¤ì¹˜ë˜ì–´ ìžˆì§€ ì•Šì•„ ì‹œí¬ë¦¿ ìŠ¤ìº”ì„ ê±´ë„ˆëœë‹ˆë‹¤."
  echo "   ì„¤ì¹˜ ë°©ë²•: macOS â†’ brew install gitleaks / Windows â†’ choco install gitleaks"
  exit 1
else
  echo "pre-push / ì‹œí¬ë¦¿ í‚¤ ê²€ì¦..."
  gitleaks detect --no-git --source . --redact --no-banner
fi

echo "pre-push / í™˜ê²½ ë³€ìˆ˜ ìœ íš¨ì„± ê²€ì¦...";   yarn env:check:light || exit 1     # 3. í™˜ê²½ ë³€ìˆ˜ ìœ íš¨ì„± ê²€ì¦
echo "pre-push / ì—„ê²©í•œ Lint ê·œì¹™ ê²€ì¦...";  yarn lint:strict     || exit 1     # 4. ì½”ë“œ ìŠ¤íƒ€ì¼ ê·œì¹™ ê²€ì¦
echo "pre-push / íƒ€ìž… ì•ˆì „ì„± ê²€ì¦...";       yarn typecheck       || exit 1     # 5. íƒ€ìž… ì•ˆì „ì„± ê²€ì¦

# 6. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸(Jest + RTL)
echo "pre-push / ì½”ë“œ ìˆ˜í–‰(ì—†ìœ¼ë©´ ìžë™ í†µê³¼)..."
if git rev-parse --abbrev-ref @{upstream} >/dev/null 2>&1; then
  yarn test:related || exit 1
else
  yarn jest --bail --maxWorkers=50% --onlyChanged --passWithNoTests || exit 1
fi